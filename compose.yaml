x-watch-dockerfile: &watch-dockerfile-rebuild
  action: rebuild
  path: towerify/Dockerfile
x-watch-composer: &watch-composer-rebuild
  action: rebuild
  path: composer.json
x-watch-package: &watch-package-rebuild
  action: rebuild
  path: package.json
x-watch-config: &watch-config-restart
  action: sync+restart
  path: ./config
  target: /var/www/html/config
x-watch-env: &watch-env-restart
  action: sync+restart
  path: .env
  target: /var/www/html/.env.temp
x-watch-routes: &watch-routes-restart
  action: sync+restart
  path: ./routes
  target: /var/www/html/routes
x-watch-views: &watch-views-restart
  action: sync+restart
  path: ./resources/views
  target: /var/www/html/resources/views
x-watch-themes: &watch-themes-restart
  action: sync+restart
  path: ./resources/themes
  target: /var/www/html/resources/themes
x-watch-wave-views: &watch-wave-views-restart
  action: sync+restart
  path: ./wave/resources/views
  target: /var/www/html/wave/resources/views
x-watch-app-sync: &watch-app-sync
  action: sync
  path: .
  target: /var/www/html
  ignore:
    - config/
    - node_modules/
    - resources/themes/
    - resources/views/
    - routes/
    - vendor/


x-common: &common
  image: cywise-ui:local-build
  build:
    context: .
    dockerfile: towerify/Dockerfile
  restart: always
  extra_hosts:
    host.docker.internal: host-gateway
  env_file:
    - .env

services:
  app:
    <<: *common
    ports:
      - target: 80
        published: 8080
    volumes:
      - ./data/scout:/var/www/html/storage/scout
    environment:
      - LOG_CHANNEL=stderr
      - DB_CONNECTION=mysql
      - DB_HOST=host.docker.internal
      - DB_PORT=3306
    develop:
      watch:
        - <<: *watch-app-sync
        - <<: *watch-dockerfile-rebuild
        - <<: *watch-composer-rebuild
        - <<: *watch-package-rebuild
        - <<: *watch-env-restart
        - <<: *watch-config-restart
        - <<: *watch-routes-restart
        - <<: *watch-views-restart
        - <<: *watch-themes-restart
        - <<: *watch-wave-views-restart
    deploy:
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first

  scheduler:
    <<: *common
    environment:
      - CONTAINER_ROLE=scheduler
      - LOG_CHANNEL=stderr
      - DB_CONNECTION=mysql
      - DB_HOST=host.docker.internal
      - DB_PORT=3306
    develop:
      watch:
        - <<: *watch-app-sync
        - <<: *watch-dockerfile-rebuild
        - <<: *watch-composer-rebuild
        - <<: *watch-package-rebuild
        - <<: *watch-env-restart
        - <<: *watch-config-restart

  queue:
    <<: *common
    environment:
      - CONTAINER_ROLE=queue
      - LOG_CHANNEL=stderr
      - DB_CONNECTION=mysql
      - DB_HOST=host.docker.internal
      - DB_PORT=3306
    develop:
      watch:
        - <<: *watch-app-sync
        - <<: *watch-dockerfile-rebuild
        - <<: *watch-composer-rebuild
        - <<: *watch-package-rebuild
        - <<: *watch-env-restart
        - <<: *watch-config-restart

  queue-low:
    <<: *common
    environment:
      - CONTAINER_ROLE=queue
      - QUEUE_NAME=low
      - LOG_CHANNEL=stderr
      - DB_CONNECTION=mysql
      - DB_HOST=host.docker.internal
      - DB_PORT=3306
    develop:
      watch:
        - <<: *watch-app-sync
        - <<: *watch-dockerfile-rebuild
        - <<: *watch-composer-rebuild
        - <<: *watch-package-rebuild
        - <<: *watch-env-restart
        - <<: *watch-config-restart

  queue-medium:
    <<: *common
    environment:
      - CONTAINER_ROLE=queue
      - QUEUE_NAME=medium
      - LOG_CHANNEL=stderr
      - DB_CONNECTION=mysql
      - DB_HOST=host.docker.internal
      - DB_PORT=3306
    develop:
      watch:
        - <<: *watch-app-sync
        - <<: *watch-dockerfile-rebuild
        - <<: *watch-composer-rebuild
        - <<: *watch-package-rebuild
        - <<: *watch-env-restart
        - <<: *watch-config-restart

  queue-critical:
    <<: *common
    environment:
      - CONTAINER_ROLE=queue
      - QUEUE_NAME=critical
      - LOG_CHANNEL=stderr
      - DB_CONNECTION=mysql
      - DB_HOST=host.docker.internal
      - DB_PORT=3306
    develop:
      watch:
        - <<: *watch-app-sync
        - <<: *watch-dockerfile-rebuild
        - <<: *watch-composer-rebuild
        - <<: *watch-package-rebuild
        - <<: *watch-env-restart
        - <<: *watch-config-restart
    deploy:
      replicas: 3

  queue-scout:
    <<: *common
    environment:
      - CONTAINER_ROLE=queue
      - QUEUE_NAME=scout
      - LOG_CHANNEL=stderr
      - DB_CONNECTION=mysql
      - DB_HOST=host.docker.internal
      - DB_PORT=3306
    develop:
      watch:
        - <<: *watch-app-sync
        - <<: *watch-dockerfile-rebuild
        - <<: *watch-composer-rebuild
        - <<: *watch-package-rebuild
        - <<: *watch-env-restart
        - <<: *watch-config-restart
    volumes:
      - ./data/scout:/var/www/html/storage/scout
