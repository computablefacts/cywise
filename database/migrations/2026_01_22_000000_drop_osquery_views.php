<?php

use Illuminate\Database\Migrations\Migration;

return new class extends Migration {
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        DB::statement("DROP VIEW `v_authorized_keys` ");
        DB::statement("DROP VIEW `v_etc_hosts`");
        DB::statement("DROP VIEW `v_etc_services`");
        DB::statement("DROP VIEW `v_groups`");
        DB::statement("DROP VIEW `v_kernel_modules`");
        DB::statement("DROP VIEW `v_ld_preload`");
        DB::statement("DROP VIEW `v_logins_and_logouts`");
        DB::statement("DROP VIEW `v_network_interfaces`");
        DB::statement("DROP VIEW `v_packages`");
        DB::statement("DROP VIEW `v_processes`");
        DB::statement("DROP VIEW `v_processes_with_bound_network_sockets`");
        DB::statement("DROP VIEW `v_processes_with_open_network_sockets`");
        DB::statement("DROP VIEW `v_scheduled_tasks`");
        DB::statement("DROP VIEW `v_services`");
        DB::statement("DROP VIEW `v_shell_history`");
        DB::statement("DROP VIEW `v_startup_items`");
        DB::statement("DROP VIEW `v_suid_binaries`");
        DB::statement("DROP VIEW `v_user_accounts`");
        DB::statement("DROP VIEW `v_user_ssh_keys`");
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        DB::statement("CREATE OR REPLACE VIEW `v_authorized_keys` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.key_file')) AS `key_file`,concat(left(json_unquote(json_extract(`ynh_osquery`.`columns`,'$.key')),15),'[...]',right(json_unquote(json_extract(`ynh_osquery`.`columns`,'$.key')),15)) AS `key`,case when json_unquote(json_extract(`ynh_osquery`.`columns`,'$.comment')) = 'null' then NULL else json_unquote(json_extract(`ynh_osquery`.`columns`,'$.comment')) end AS `key_comment`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.algorithm')) AS `algorithm`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((`ynh_osquery` join `ynh_servers` on(`ynh_servers`.`id` = `ynh_osquery`.`ynh_server_id`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`)) where `ynh_osquery`.`name` = 'authorized_keys'");
        DB::statement("CREATE OR REPLACE VIEW `v_etc_hosts` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.address')) AS `address`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.hostnames')) AS `hostnames`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'etc_hosts') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_etc_services` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) AS `name`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.port')) AS `port`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.protocol')) AS `protocol`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.comment')) AS `comment`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name2`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'etc_services') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_groups` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.groupname')) AS `name`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.gid')) AS `gid`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `ynh_osquery_name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from (((`ynh_osquery` join `ynh_osquery_latest_events` on(`ynh_osquery_latest_events`.`ynh_osquery_id` = `ynh_osquery`.`id` and `ynh_osquery_latest_events`.`event_name` = 'groups')) join `ynh_servers` on(`ynh_servers`.`id` = `ynh_osquery`.`ynh_server_id`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_kernel_modules` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) AS `name`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `ynh_osquery_name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'kernel_modules') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_ld_preload` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) AS `program`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.value')) AS `ld_preload_value`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'ld_preload') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_logins_and_logouts` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.pid')) AS `pid`,case when json_unquote(json_extract(`ynh_osquery`.`columns`,'$.host')) = 'null' then NULL else json_unquote(json_extract(`ynh_osquery`.`columns`,'$.host')) end AS `entry_host`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.time')) AS `entry_timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.tty')) AS `entry_terminal`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.type_name')) AS `entry_type`,case when json_unquote(json_extract(`ynh_osquery`.`columns`,'$.username')) = 'null' then NULL else json_unquote(json_extract(`ynh_osquery`.`columns`,'$.username')) end AS `entry_username`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((`ynh_osquery` join `ynh_servers` on(`ynh_servers`.`id` = `ynh_osquery`.`ynh_server_id`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`)) where `ynh_osquery`.`name` = 'last'");
        DB::statement("CREATE OR REPLACE VIEW `v_network_interfaces` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.address')) AS `address`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.broadcast')) AS `broadcast`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.interface')) AS `interface`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.mask')) AS `mask`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.point_to_point')) AS `point_to_point`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.type')) AS `type`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'interface_addresses') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_packages` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,case `t`.`_type` when 1 then 'win' when 2 then 'deb' when 3 then 'portage' when 4 then 'npm' when 5 then 'python' when 6 then 'rpm' when 7 then 'homebrew' when 8 then 'chocolatey' else 'n/a' end AS `type`,case `t`.`_type` when 1 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) when 2 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) when 3 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) when 4 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) when 5 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) when 6 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) when 7 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) when 8 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) else 'n/a' end AS `package`,case `t`.`_type` when 1 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.version')) when 2 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.version')) when 3 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.version')) when 4 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.version')) when 5 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.version')) when 6 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.version')) when 7 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.version')) when 8 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.version')) else 'n/a' end AS `version`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select 1 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'win_packages' union select 2 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'deb_packages' union select 3 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'portage_packages' union select 4 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'npm_packages' union select 5 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'python_packages' union select 6 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'rpm_packages' union select 7 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'homebrew_packages' union select 8 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'chocolatey_packages') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_processes` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.pid')) AS `pid`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) AS `name`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.cmdline')) AS `command`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) AS `path`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name2`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'processes') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`)) where json_unquote(json_extract(`ynh_osquery`.`columns`,'$.cmdline'))  not like '%performa%' and json_unquote(json_extract(`ynh_osquery`.`columns`,'$.cmdline'))  not like '%logalert%'");
        DB::statement("CREATE OR REPLACE VIEW `v_processes_with_bound_network_sockets` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) AS `path`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.address')) AS `local_address`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.port')) AS `local_port`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'process_listening_port') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_processes_with_open_network_sockets` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.pid')) AS `pid`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) AS `path`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.local_address')) AS `local_address`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.local_port')) AS `local_port`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.remote_address')) AS `remote_address`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.remote_port')) AS `remote_port`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name2`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'open_sockets') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`)) having trim(`path`) <> '' or trim(`remote_address`) <> ''");
        DB::statement("CREATE OR REPLACE VIEW `v_scheduled_tasks` AS select `t`.`user_id` AS `user_id`,`t`.`customer_id` AS `customer_id`,`t`.`tenant_id` AS `tenant_id`,`t`.`event_id` AS `event_id`,`t`.`server_id` AS `server_id`,`t`.`server_name` AS `server_name`,`t`.`server_ip_address` AS `server_ip_address`,`t`.`timestamp` AS `timestamp`,`t`.`file` AS `file`,`t`.`command` AS `command`,`t`.`last_run_time` AS `last_run_time`,`t`.`next_run_time` AS `next_run_time`,`t`.`cron` AS `cron`,`t`.`enabled` AS `enabled`,`t`.`action` AS `action`,`t`.`name` AS `name`,`t`.`columns_uid` AS `columns_uid` from (select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,case when `t`.`_type` = 1 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) else 'n/a' end AS `file`,case when `t`.`_type` = 1 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.command')) else json_unquote(json_extract(`ynh_osquery`.`columns`,'$.action')) end AS `command`,case when `t`.`_type` = 1 then 'n/a' else date_format(from_unixtime(json_unquote(json_extract(`ynh_osquery`.`columns`,'$.last_run_time'))),'%Y-%m-%d %H:%i:%s') end AS `last_run_time`,case when `t`.`_type` = 1 then 'n/a' else date_format(from_unixtime(json_unquote(json_extract(`ynh_osquery`.`columns`,'$.next_run_time'))),'%Y-%m-%d %H:%i:%s') end AS `next_run_time`,case when `t`.`_type` = 1 then concat(json_unquote(json_extract(`ynh_osquery`.`columns`,'$.minute')),' ',json_unquote(json_extract(`ynh_osquery`.`columns`,'$.hour')),' ',json_unquote(json_extract(`ynh_osquery`.`columns`,'$.day_of_month')),' ',json_unquote(json_extract(`ynh_osquery`.`columns`,'$.month')),' ',json_unquote(json_extract(`ynh_osquery`.`columns`,'$.day_of_week'))) else 'n/a' end AS `cron`,case when `t`.`_type` = 1 then 'yes' when json_unquote(json_extract(`ynh_osquery`.`columns`,'$.enabled')) = 1 then 'yes' else 'no' end AS `enabled`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select 1 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'crontab' union select 2 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'scheduled_tasks') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))) `t` where `t`.`command`  not like '%performa%'");
        DB::statement("CREATE OR REPLACE VIEW `v_services` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,case when `t`.`_type` = 1 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) else json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) end AS `name`,case when `t`.`_type` = 1 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) else json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) end AS `path`,case when `t`.`_type` = 1 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.type')) else json_unquote(json_extract(`ynh_osquery`.`columns`,'$.service_type')) end AS `type`,case when `t`.`_type` = 1 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.status')) else json_unquote(json_extract(`ynh_osquery`.`columns`,'$.status')) end AS `status`,case when `t`.`_type` = 1 then json_unquote(json_extract(`ynh_osquery`.`columns`,'$.username')) else json_unquote(json_extract(`ynh_osquery`.`columns`,'$.user_account')) end AS `user`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name2`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select 1 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'startup_items' union select 2 AS `_type`,`ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'services') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_shell_history` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.username')) AS `username`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.shell')) AS `shell`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.command')) AS `command`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'shell_history') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_startup_items` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.name')) AS `name`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.type')) AS `type`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.status')) AS `status`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) AS `path`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name2`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'startup_items') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_suid_binaries` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) AS `program`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'suid_bin') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_user_accounts` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.uid')) AS `user`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.gid')) AS `group`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.username')) AS `username`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.directory')) AS `home_directory`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.shell')) AS `default_shell`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from (((`ynh_osquery` join `ynh_osquery_latest_events` on(`ynh_osquery_latest_events`.`ynh_osquery_id` = `ynh_osquery`.`id` and `ynh_osquery_latest_events`.`event_name` = 'users')) join `ynh_servers` on(`ynh_servers`.`id` = `ynh_osquery_latest_events`.`ynh_server_id`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
        DB::statement("CREATE OR REPLACE VIEW `v_user_ssh_keys` AS select distinct `ynh_servers`.`created_by` AS `user_id`,`users`.`customer_id` AS `customer_id`,`users`.`tenant_id` AS `tenant_id`,`ynh_osquery`.`id` AS `event_id`,`ynh_osquery`.`ynh_server_id` AS `server_id`,`ynh_servers`.`name` AS `server_name`,`ynh_servers`.`ip_address` AS `server_ip_address`,`ynh_osquery`.`calendar_time` AS `timestamp`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.username')) AS `username`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.directory')) AS `directory`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.shell')) AS `shell`,json_unquote(json_extract(`ynh_osquery`.`columns`,'$.path')) AS `ssh_key`,`ynh_osquery`.`action` AS `action`,`ynh_osquery`.`name` AS `name`,`ynh_osquery`.`columns_uid` AS `columns_uid` from ((((select `ynh_osquery_latest_events`.`ynh_osquery_id` AS `_oid`,`ynh_osquery_latest_events`.`ynh_server_id` AS `_sid` from `ynh_osquery_latest_events` where `ynh_osquery_latest_events`.`event_name` = 'user_ssh_keys') `t` join `ynh_osquery` on(`ynh_osquery`.`id` = `t`.`_oid`)) join `ynh_servers` on(`ynh_servers`.`id` = `t`.`_sid`)) join `users` on(`users`.`id` = `ynh_servers`.`created_by`))");
    }
};
